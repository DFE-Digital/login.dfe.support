<%if(locals.flash.info) {%>
<div class="notification notification-success">
    <%=locals.flash.info%>
</div>
<%}%>

<div class="row">
    <div class="col-6">
        <h1 class="heading-xlarge">Users</h1>
    </div>
</div>

<%
    const pages = locals.numberOfPages, page = locals.page
    const usersOnPage = locals.users.length, usersAll = locals.totalNumberOfResults
    let lowerEndUsers = page === pages ? usersAll - usersOnPage + 1 : usersOnPage * (page-1) + 1
    const upperEndUsers = lowerEndUsers + usersOnPage - 1

    if (locals.totalNumberOfResults === 0) {
        lowerEndUsers = 0;
    }
%>

<div class="row row-spacer">
    <div class="col-6">
        <form method="POST">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>"/>
            <div class="search-field">
                <fieldset class="search-input">
                    <label for="criteria" class="vh">Search by name, email or organisation</label>
                    <input type="text" id="criteria" name="criteria" value="<%= criteria %>" class="form-control" placeholder="Search by name, email or organisation">
                </fieldset>
                <fieldset class="search-submit">
                    <button type="submit" class="button">Search</button>
                </fieldset>
            </div>
        </form>
    </div>
    <div class="col-6">
        <div class="pull-right">
            <a href="/users/new-k2s-user" class="button button-secondary">Add User</a>
        </div>
    </div>
</div>

<div class="row meta">
    <div class="col-6">
        <p>Showing <%= lowerEndUsers %> - <%= upperEndUsers %> of <b><%=locals.totalNumberOfResults%></b> users</p>
    </div>
    <div class="col-6">
        <% if (locals.numberOfPages > 1) { %>
        <ul class="pagination">

            <% if(locals.page > 1) { %>
                <li><a href="?criteria=<%= criteria %>&page=<%= locals.page-1 %>">Previous</a></li>
            <% } %>

            <% for (let p = 1; p <= locals.numberOfPages; p++) { %>
                <% if(p === locals.page) { %>
                    <li><span class="current"> <%= p %> </span></li>
                <% } else { %>
                    <li><a href="?criteria=<%= criteria %>&page=<%= p %>"><%= p %></a></li>
                <% } %>
            <% } %>

            <% if(locals.page !== locals.numberOfPages) { %>
                <li><a href="?criteria=<%= criteria %>&page=<%= locals.page+1 %>">Next</a></li>
            <% } %>

        </ul>
        <% } %>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <table class="data">
            <thead>
                <tr class="sortable">
                    <th scope="col" class="cwp-15">
                        <a href="?criteria=<%=criteria%>&page=<%=page%>&sort=name&sortdir=<%=sort.name.nextDirection%>"
                           class="<% if (sort.name.applied) { %>sorted dir-<%= (sort.name.nextDirection === 'desc') ? 'd' : 'a' %><% } %>"
                        >Name</a></th>
                    <th scope="col" class="cwp-35">
                        <a href="?criteria=<%=criteria%>&page=<%=page%>&sort=email&sortdir=<%=sort.email.nextDirection%>"
                           class="<% if (sort.email.applied) { %>sorted dir-<%= (sort.email.nextDirection === 'desc') ? 'd' : 'a' %><% } %>"
                        >Email</a></th>
                    <th scope="col" class="cwp-25">
                        <a href="?criteria=<%=criteria%>&page=<%=page%>&sort=organisation&sortdir=<%=sort.organisation.nextDirection%>"
                           class="<% if (sort.organisation.applied) { %>sorted dir-<%= (sort.organisation.nextDirection === 'desc') ? 'd' : 'a' %><% } %>"
                        >Organisation</a></th>
                    <th scope="col" class="cwp-15">
                        <a href="?criteria=<%=criteria%>&page=<%=page%>&sort=lastlogin&sortdir=<%=sort.lastLogin.nextDirection%>"
                           class="<% if (sort.lastLogin.applied) { %>sorted dir-<%= (sort.lastLogin.nextDirection === 'desc') ? 'd' : 'a' %><% } %>"
                        >Last Login</a></th>
                    <th scope="col" class="cwp-10">
                        <a href="?criteria=<%=criteria%>&page=<%=page%>&sort=status&sortdir=<%=sort.status.nextDirection%>"
                           class="<% if (sort.status.applied) { %>sorted dir-<%= (sort.status.nextDirection === 'desc') ? 'd' : 'a' %><% } %>"
                        >Status</a></th>
                </tr>
            </thead>
            <tbody>
            <% if(locals.users.length === 0 && locals.criteria) { %>
                <tr>
                    <td colspan="5"><span class="empty-state">No users found</span></td>
                </tr>
            <% } %>
            <% for (let i = 0; i < locals.users.length; i++) { %>
                <tr>
                    <td><a href="/users/<%=users[i].id%>/"><%= users[i].name %></a></td>

                    <td><span class="breakable"><%= users[i].email %></span></td>
                    <td>
                    <% if(users[i].organisation) { %>
                        <%= users[i].organisation.name %>
                    <% }else { %>
                        Unknown
                    <% } %>
                    </td>
                    <td>
                    <% if(locals.users[i].lastLogin) { %>
                        <%= locals.moment(locals.users[i].lastLogin).fromNow() %>
                    <% } else { %>
                        Never
                    <% } %>
                    </td>
                    <td><%= users[i].status.description %></td>
                </tr>
            <% } %>
            </tbody>
        </table>
    </div>
</div>

<div class="row meta">
    <div class="col-12">
        <% if (locals.numberOfPages > 1) { %>
        <ul class="pagination">

            <% if(locals.page > 1) { %>
            <li><a href="?criteria=<%= criteria %>&page=<%= locals.page-1 %>">Previous</a></li>
            <% } %>

            <% for (let p = 1; p <= locals.numberOfPages; p++) { %>
            <% if(p === locals.page) { %>
            <li><span class="current"> <%= p %> </span></li>
            <% } else { %>
            <li><a href="?criteria=<%= criteria %>&page=<%= p %>"><%= p %></a></li>
            <% } %>
            <% } %>

            <% if(locals.page !== locals.numberOfPages) { %>
            <li><a href="?criteria=<%= criteria %>&page=<%= locals.page+1 %>">Next</a></li>
            <% } %>

        </ul>
        <% } %>
    </div>
</div>